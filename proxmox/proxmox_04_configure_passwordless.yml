---
# =============================================================================
# PROXMOX PLAYBOOK 04: Configure Passwordless SSH from Proxmox Host
# =============================================================================
# IMPORTANT: This playbook runs ONLY on the Proxmox server itself!
#            Do NOT run this from a remote Ansible control node.
#            Install Ansible directly on your Proxmox host.
#
# WHAT YOU'LL LEARN:
#   - Configuring SSH daemon (sshd) settings via pct/qm exec
#   - Disabling password authentication for security
#   - Setting up known_hosts for seamless connections
#   - Adding guests to SSH config for easy access
#   - Creating an Ansible inventory from Proxmox guests
#
# SECURITY BEST PRACTICES:
#   - Key-based auth is more secure than passwords
#   - Disabling password auth prevents brute force attacks
#   - Use dedicated SSH keys for automation
#   - Consider setting up a bastion host pattern
#
# PREREQUISITES:
#   - SSH keys already copied (run proxmox_03_prep_ssh_keys.yml first)
#   - Guests are running and accessible
#   - For VMs: QEMU guest agent installed
#
# RUN THIS PLAYBOOK:
#   ansible-playbook proxmox/proxmox_04_configure_passwordless.yml
#
# FOR SPECIFIC GUESTS:
#   ansible-playbook proxmox/proxmox_04_configure_passwordless.yml \
#     -e '{"target_guests": [{"id": 100, "type": "ct"}]}'
# =============================================================================

- name: Proxmox - Configure Passwordless SSH Access
  # ---------------------------------------------------------------------------
  # HOST CONFIGURATION
  # ---------------------------------------------------------------------------
  hosts: localhost
  connection: local
  gather_facts: true
  become: true

  # ---------------------------------------------------------------------------
  # VARIABLES
  # ---------------------------------------------------------------------------
  vars:
    # =========================================================================
    # SSH CONFIGURATION OPTIONS
    # =========================================================================
    # ssh_key_path: Path to your SSH key (for known_hosts scanning)
    ssh_key_path: "/root/.ssh/id_rsa"

    # disable_password_auth: Whether to disable password authentication
    # Set to true for maximum security (requires working key auth first!)
    disable_password_auth: false

    # permit_root_login: SSH root login setting
    # Options: 'yes', 'no', 'prohibit-password', 'forced-commands-only'
    # 'prohibit-password' allows key auth but not password
    permit_root_login: "prohibit-password"

    # create_ssh_config: Create SSH config entries for easy access
    create_ssh_config: true

    # create_ansible_inventory: Generate an Ansible inventory file
    create_ansible_inventory: true

    # inventory_path: Where to write the generated inventory
    inventory_path: "/etc/ansible/hosts.d/proxmox_guests.yml"

    # =========================================================================
    # TARGET CONFIGURATION
    # =========================================================================
    # Same format as proxmox_03_prep_ssh_keys.yml
    target_guests: []

    # auto_discover: Find all running guests if target_guests is empty
    auto_discover: true

    # target_user: Default user for SSH configuration
    target_user: "root"

  # ---------------------------------------------------------------------------
  # TASKS
  # ---------------------------------------------------------------------------
  tasks:

    # =========================================================================
    # TASK 1: Introduction
    # =========================================================================
    - name: Display playbook introduction
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "  Passwordless SSH Configuration"
          - "============================================"
          - "  This playbook will:"
          - "    1. Configure SSHD for key-based auth"
          - "    2. Add guest fingerprints to known_hosts"
          - "    3. Create SSH config aliases"
          - "    4. Generate Ansible inventory"
          - "============================================"

    # =========================================================================
    # TASK 2: Auto-Discover Guests (if needed)
    # =========================================================================
    - name: Auto-discover running guests
      when: target_guests | length == 0 and auto_discover
      block:
        - name: Get running containers
          ansible.builtin.shell:
            cmd: "pct list | grep running | awk '{print $1}'"
          register: running_containers
          changed_when: false
          failed_when: false

        - name: Get running VMs
          ansible.builtin.shell:
            cmd: "qm list | grep running | awk '{print $1}'"
          register: running_vms
          changed_when: false
          failed_when: false

        - name: Build container targets
          ansible.builtin.set_fact:
            container_targets: "{{ running_containers.stdout_lines | default([]) | map('regex_replace', '^(.*)$', '{\"id\": \\1, \"type\": \"ct\"}') | map('from_json') | list }}"
          when: running_containers.stdout_lines | default([]) | length > 0

        - name: Build VM targets
          ansible.builtin.set_fact:
            vm_targets: "{{ running_vms.stdout_lines | default([]) | map('regex_replace', '^(.*)$', '{\"id\": \\1, \"type\": \"vm\"}') | map('from_json') | list }}"
          when: running_vms.stdout_lines | default([]) | length > 0

        - name: Combine targets
          ansible.builtin.set_fact:
            target_guests: "{{ (container_targets | default([])) + (vm_targets | default([])) }}"

        - name: Display discovered guests
          ansible.builtin.debug:
            msg: "Discovered guests: {{ target_guests | map(attribute='id') | list }}"

    - name: Verify we have targets
      ansible.builtin.fail:
        msg: "No target guests found. Start some containers/VMs or specify targets."
      when: target_guests | length == 0

    # =========================================================================
    # TASK 3: Gather Guest Information
    # =========================================================================
    # We need hostnames and IPs for each guest
    - name: Initialize guest info list
      ansible.builtin.set_fact:
        guest_info: []

    # Process containers
    - name: Gather container information
      when: item.type == 'ct'
      block:
        - name: "Container {{ item.id }}: Get hostname"
          ansible.builtin.shell:
            cmd: "pct exec {{ item.id }} -- hostname"
          register: ct_hostname
          changed_when: false

        - name: "Container {{ item.id }}: Get IP address"
          ansible.builtin.shell:
            cmd: "pct exec {{ item.id }} -- hostname -I | awk '{print $1}'"
          register: ct_ip
          changed_when: false

        - name: "Container {{ item.id }}: Add to guest info"
          ansible.builtin.set_fact:
            guest_info: >-
              {{ guest_info + [{
                'id': item.id,
                'type': 'ct',
                'hostname': ct_hostname.stdout | trim,
                'ip': ct_ip.stdout | trim,
                'user': item.user | default(target_user)
              }] }}

      loop: "{{ target_guests | selectattr('type', 'equalto', 'ct') | list }}"
      loop_control:
        label: "Container {{ item.id }}"

    # Process VMs
    - name: Gather VM information
      when: item.type == 'vm'
      block:
        - name: "VM {{ item.id }}: Check guest agent"
          ansible.builtin.command:
            cmd: "qm guest cmd {{ item.id }} ping"
          register: vm_agent
          failed_when: false
          changed_when: false

        - name: "VM {{ item.id }}: Get hostname via agent"
          ansible.builtin.shell:
            cmd: "qm guest exec {{ item.id }} -- hostname | jq -r '.\"out-data\"' | tr -d '\n'"
          register: vm_hostname
          when: vm_agent.rc == 0
          changed_when: false
          failed_when: false

        - name: "VM {{ item.id }}: Get IP via agent"
          ansible.builtin.shell:
            # Parse the network interfaces JSON to get the IP
            cmd: |
              qm guest cmd {{ item.id }} network-get-interfaces | \
              jq -r '.[] | select(.name != "lo") | .["ip-addresses"][]? | select(.["ip-address-type"] == "ipv4") | .["ip-address"]' | \
              head -1
          register: vm_ip
          when: vm_agent.rc == 0
          changed_when: false
          failed_when: false

        - name: "VM {{ item.id }}: Add to guest info"
          ansible.builtin.set_fact:
            guest_info: >-
              {{ guest_info + [{
                'id': item.id,
                'type': 'vm',
                'hostname': vm_hostname.stdout | default('vm-' + item.id|string) | trim,
                'ip': vm_ip.stdout | default('') | trim,
                'user': item.user | default(target_user),
                'agent_available': vm_agent.rc == 0
              }] }}
          when: vm_agent.rc == 0

        - name: "VM {{ item.id }}: Agent not available"
          ansible.builtin.debug:
            msg: "Skipping VM {{ item.id }} - guest agent not responding"
          when: vm_agent.rc != 0

      loop: "{{ target_guests | selectattr('type', 'equalto', 'vm') | list }}"
      loop_control:
        label: "VM {{ item.id }}"

    - name: Display gathered guest information
      ansible.builtin.debug:
        msg: "{{ guest_info }}"
        verbosity: 1

    # =========================================================================
    # TASK 4: Configure SSHD on Each Guest
    # =========================================================================
    - name: Configure SSHD on containers
      when: item.type == 'ct'
      block:
        - name: "Container {{ item.id }}: Enable PubkeyAuthentication"
          ansible.builtin.shell:
            cmd: |
              pct exec {{ item.id }} -- sed -i 's/^#*PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config
              pct exec {{ item.id }} -- grep -q '^PubkeyAuthentication' /etc/ssh/sshd_config || \
                pct exec {{ item.id }} -- sh -c 'echo "PubkeyAuthentication yes" >> /etc/ssh/sshd_config'

        - name: "Container {{ item.id }}: Configure PermitRootLogin"
          ansible.builtin.shell:
            cmd: |
              pct exec {{ item.id }} -- sed -i 's/^#*PermitRootLogin.*/PermitRootLogin {{ permit_root_login }}/' /etc/ssh/sshd_config
              pct exec {{ item.id }} -- grep -q '^PermitRootLogin' /etc/ssh/sshd_config || \
                pct exec {{ item.id }} -- sh -c 'echo "PermitRootLogin {{ permit_root_login }}" >> /etc/ssh/sshd_config'

        - name: "Container {{ item.id }}: Disable PasswordAuthentication"
          ansible.builtin.shell:
            cmd: |
              pct exec {{ item.id }} -- sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
          when: disable_password_auth

        - name: "Container {{ item.id }}: Restart SSHD"
          ansible.builtin.shell:
            cmd: |
              pct exec {{ item.id }} -- systemctl restart sshd || \
              pct exec {{ item.id }} -- service ssh restart || \
              pct exec {{ item.id }} -- /etc/init.d/ssh restart

      loop: "{{ guest_info | selectattr('type', 'equalto', 'ct') | list }}"
      loop_control:
        label: "Container {{ item.id }}"

    - name: Configure SSHD on VMs (with agent)
      when: item.type == 'vm' and (item.agent_available | default(false))
      block:
        - name: "VM {{ item.id }}: Enable PubkeyAuthentication"
          ansible.builtin.shell:
            cmd: |
              qm guest exec {{ item.id }} -- sed -i 's/^#*PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config

        - name: "VM {{ item.id }}: Configure PermitRootLogin"
          ansible.builtin.shell:
            cmd: |
              qm guest exec {{ item.id }} -- sed -i 's/^#*PermitRootLogin.*/PermitRootLogin {{ permit_root_login }}/' /etc/ssh/sshd_config

        - name: "VM {{ item.id }}: Restart SSHD"
          ansible.builtin.shell:
            cmd: |
              qm guest exec {{ item.id }} -- systemctl restart sshd
          failed_when: false

      loop: "{{ guest_info | selectattr('type', 'equalto', 'vm') | list }}"
      loop_control:
        label: "VM {{ item.id }}"

    # =========================================================================
    # TASK 5: Add to Known Hosts
    # =========================================================================
    # This prevents the "unknown host" prompt on first connection
    - name: Add guests to known_hosts
      when: item.ip | default('') | length > 0
      block:
        - name: "{{ item.hostname }}: Scan SSH host key"
          ansible.builtin.shell:
            # ssh-keyscan retrieves the host's public key
            cmd: "ssh-keyscan -H {{ item.ip }} 2>/dev/null"
          register: host_key
          changed_when: false
          failed_when: false

        - name: "{{ item.hostname }}: Add to known_hosts"
          ansible.builtin.lineinfile:
            path: "/root/.ssh/known_hosts"
            line: "{{ host_key.stdout }}"
            create: true
            mode: '0600'
          when: host_key.stdout | length > 0

      loop: "{{ guest_info }}"
      loop_control:
        label: "{{ item.hostname }} ({{ item.ip }})"

    # =========================================================================
    # TASK 6: Create SSH Config Entries
    # =========================================================================
    - name: Create SSH config for easy access
      when: create_ssh_config
      block:
        - name: Ensure SSH config file exists
          ansible.builtin.file:
            path: "/root/.ssh/config"
            state: touch
            mode: '0600'

        - name: Add SSH config header for Proxmox guests
          ansible.builtin.blockinfile:
            path: "/root/.ssh/config"
            marker: "# {mark} PROXMOX MANAGED GUESTS"
            block: |
              # Auto-generated by proxmox_04_configure_passwordless.yml
              # Regenerate by running the playbook again

              {% for guest in guest_info %}
              {% if guest.ip | default('') | length > 0 %}
              # {{ guest.type | upper }} {{ guest.id }} - {{ guest.hostname }}
              Host {{ guest.hostname }} pve-{{ guest.id }}
                  HostName {{ guest.ip }}
                  User {{ guest.user }}
                  IdentityFile {{ ssh_key_path }}
                  StrictHostKeyChecking no
                  UserKnownHostsFile /dev/null
                  LogLevel ERROR

              {% endif %}
              {% endfor %}
            create: true
            mode: '0600'

        - name: Display SSH shortcuts
          ansible.builtin.debug:
            msg:
              - "SSH shortcuts created! You can now use:"
              - "{% for guest in guest_info %}{% if guest.ip | default('') | length > 0 %}  ssh {{ guest.hostname }}  OR  ssh pve-{{ guest.id }}\n{% endif %}{% endfor %}"

    # =========================================================================
    # TASK 7: Create Ansible Inventory
    # =========================================================================
    - name: Create Ansible inventory file
      when: create_ansible_inventory
      block:
        - name: Ensure inventory directory exists
          ansible.builtin.file:
            path: "{{ inventory_path | dirname }}"
            state: directory
            mode: '0755'

        - name: Generate Ansible inventory
          ansible.builtin.copy:
            dest: "{{ inventory_path }}"
            mode: '0644'
            content: |
              # =============================================================================
              # Proxmox Guests Inventory
              # =============================================================================
              # Auto-generated by proxmox_04_configure_passwordless.yml
              # Regenerate by running the playbook again
              #
              # Usage:
              #   ansible all -i {{ inventory_path }} -m ping
              #   ansible proxmox_containers -i {{ inventory_path }} -m ping
              # =============================================================================

              all:
                children:
                  proxmox_guests:
                    children:
                      proxmox_containers:
                        hosts:
              {% for guest in guest_info | selectattr('type', 'equalto', 'ct') %}
              {% if guest.ip | default('') | length > 0 %}
                          {{ guest.hostname }}:
                            ansible_host: {{ guest.ip }}
                            ansible_user: {{ guest.user }}
                            proxmox_id: {{ guest.id }}
                            proxmox_type: container
              {% endif %}
              {% endfor %}
                      proxmox_vms:
                        hosts:
              {% for guest in guest_info | selectattr('type', 'equalto', 'vm') %}
              {% if guest.ip | default('') | length > 0 %}
                          {{ guest.hostname }}:
                            ansible_host: {{ guest.ip }}
                            ansible_user: {{ guest.user }}
                            proxmox_id: {{ guest.id }}
                            proxmox_type: vm
              {% endif %}
              {% endfor %}

                vars:
                  ansible_ssh_private_key_file: {{ ssh_key_path }}
                  ansible_ssh_common_args: '-o StrictHostKeyChecking=no'

        - name: Display inventory location
          ansible.builtin.debug:
            msg: "Ansible inventory created at: {{ inventory_path }}"

    # =========================================================================
    # TASK 8: Test SSH Connections
    # =========================================================================
    - name: Test SSH connections to guests
      when: item.ip | default('') | length > 0
      ansible.builtin.command:
        cmd: "ssh -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -i {{ ssh_key_path }} {{ item.user }}@{{ item.ip }} echo 'SSH OK'"
      register: ssh_test
      failed_when: false
      changed_when: false
      loop: "{{ guest_info }}"
      loop_control:
        label: "{{ item.hostname }}"

    - name: Display SSH test results
      ansible.builtin.debug:
        msg: "{{ item.item.hostname }}: {{ 'SUCCESS' if item.rc == 0 else 'FAILED - ' + (item.stderr | default('unknown error')) }}"
      loop: "{{ ssh_test.results }}"
      loop_control:
        label: "{{ item.item.hostname }}"
      when: ssh_test.results is defined

    # =========================================================================
    # TASK 9: Final Summary
    # =========================================================================
    - name: Display completion summary
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "  Passwordless SSH Configuration Complete"
          - "============================================"
          - ""
          - "CONFIGURED GUESTS:"
          - "{% for guest in guest_info %}{% if guest.ip | default('') | length > 0 %}  {{ guest.id }}: {{ guest.hostname }} ({{ guest.ip }})\n{% endif %}{% endfor %}"
          - ""
          - "SSH SHORTCUTS (in ~/.ssh/config):"
          - "{% for guest in guest_info %}{% if guest.ip | default('') | length > 0 %}  ssh {{ guest.hostname }}\n{% endif %}{% endfor %}"
          - ""
          - "ANSIBLE INVENTORY: {{ inventory_path }}"
          - ""
          - "TEST COMMANDS:"
          - "  Single host:  ssh {{ (guest_info | first).hostname | default('hostname') }}"
          - "  Ansible ping: ansible all -i {{ inventory_path }} -m ping"
          - ""
          - "NEXT STEPS:"
          - "  1. Test SSH access: ssh <hostname>"
          - "  2. Run proxmox_05_homelab_structure.yml for folder setup"
          - "  3. Use the inventory for Ansible playbooks"
          - "============================================"
